/*

 Copyright (C) 2009-2012. David Thevenin, ViniSketch SARL (c), and 
 contributors. All rights reserved

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU Lesser General Public License as published
 by the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 GNU Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public License
 along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
(function(o,v){function t(){return"vs_id_"+I++}function D(a,b){f.isNumber(a)&&(this.x=a);f.isNumber(b)&&(this.y=b)}function p(a){this.constructor=i.Object;this._id=f.isString(a)?a:a&&a.id?a.id:t();a&&(this.__config__=f.clone(a))}function J(a,b){var c={},e,g,h,j;for(j in b){e=b[j];if(f.isNumber(e))g={},h="_"+f.underscore(j),e&m.core.Object.PROPERTY_IN&&(g.set=function(a,b){return function(c){this[b]=c;this.propertyChange(a)}}(j,h)),e&m.core.Object.PROPERTY_OUT&&(g.get=function(a){return function(){return this[a]}}(h));
else if(f.isString(e)){h=K.exec(e);if(!h||3!=h.length)throw"Unvalid property path: "+e;g={};g.set=function(a,b){return function(c){this[a][b]=c;this.propertyChange(b)}}(h[1],h[2]);g.get=function(a,b){return function(){return this[a][b]}}(h[1],h[2])}else"object"==typeof e&&(g=e);c[j]=g}f.defineClassProperties(a,c)}function z(a){this.parent=i.Object;this.parent(a);this.constructor=m.core.Model;this.__bindings__={};this.__links__=[]}function E(a,b,c,e){this.spec=a;this.obj=b;this.delay=FORCE_EVENT_PROPAGATION_DELAY?
!0:e;f.isFunction(c)?this.func_ptr=c:this.func=c}function s(a){this.parent=i.Object;this.parent(a);this.constructor=i.EventSource;this.__bindings__={};this.__node_binds__={}}function F(){this.dataflow_node=[];this.dataflow_edges={};this.is_propagating=!1;this._node_link={};this.__shouldnt_propagate__=0}function n(a){this.parent=i.Object;this.parent(a);this.constructor=n}function A(a){this.parent=i.Object;this.parent();this.constructor=A;this._tasksAndParams=[];arguments.length&&this.setTasks(arguments)}
function B(a){this.parent=i.Object;this.parent();this.constructor=B;this._tasksAndParams=[];arguments.length&&this.setTasks(arguments)}function w(a){this.parent=i.Object;this.parent();this.constructor=w;this.time=a}function d(){this.deviceId=this.orientation=null;this.targets={};this.browserDetect();this.orientationDetect();this.screenDetect()}function x(a){this.parent=m.core.Model;this.parent(a);this.constructor=m.core.Array}function q(a){this.parent=i.EventSource;this.parent(a);this.constructor=
m.core.DataStorage;this.__models__={}}function G(a){this.parent=q;this.parent(a);this.constructor=m.core.LocalStorage}function u(a){this.parent=q;this.parent(a);this.constructor=u;this._xhrs={}}var H=o.document,m=o.vs,f=m.util,i=m.core,I=0;i.createId=t;i.createUniqueId=function(){return"vs_id_"+(new Date).getTime()+""+Math.floor(1E6*Math.random())};D.prototype={x:0,y:0,matrixTransform:function(a){var b=new m.CSSMatrix,b=b.translate(this.x,this.y,this.z||0),a=a.multiply(b),c=new D(a.m41,a.m42);delete b;
delete a;return c}};m.Point=D;p.prototype={_id:"",__i__:!1,__config__:null,init:function(a){if(this.__i__)return this;this._id||(this._id=t());p._obs[this._id]=this;a||this.initComponent();this.__i__=!0;!a&&this.vsdInit&&this.vsdInit();this.__config__&&(this.configure(this.__config__),delete this.__config__);this.componentDidInitialize&&this.componentDidInitialize();this.initSkin&&(console.warn("Your application shouldn't use initSkin anymore.\nYou should rename by componentDidInitialize."),p.prototype.initSkin=
function(){},this.initSkin(),p.prototype.initSkin=v);return this},initComponent:function(){},createId:function(){console.warn("this.createId is deprecated, Use the static method vs.core.createId instead");return t()},configure:function(a){if("object"===typeof a){var b,c,e,g=!1,h=r[this._id];h&&h.pausePropagation();if(a instanceof z)if((b=this.getPropertyDescriptor("model"))&&b.set)this.model=a,g=!0;else{b=a.getProperties();for(e=0;e<b.length;e++)c=b[e],"id"!==c&&(this[c]=a[c],g=!0)}else if(a)for(c in a)"id"===
c||"node"===c||"node_ref"===c||"view"===c||(this[c]=a[c],g=!0);h?(h.restartPropagation(),g&&(this.propertiesDidChange&&this.propertiesDidChange(),h.propagate(this._id))):g&&this.propertiesDidChange&&this.propertiesDidChange()}},getProperties:function(){return!this.constructor._properties_?[]:this.constructor._properties_.slice()},toJSON:function(){return this._toJSON("{")+"}"},parseJSON:function(a){try{var b=a&&f.parseJSON(a)||{},c;for(c in b)this["_"+c]=void 0}catch(e){console.error("vs.core.Object.parseJSON failed. "+
e.toString())}},_toJSON:function(a){var b,c,e,g=this.constructor._properties_,h=0;if(!g)return a;for(var j=0;j<g.length;j++)if(b=g[j],c=this["_"+b],"undefined"!=typeof c){if(null==c)e="null";else if(c instanceof Date)e='"/Date('+c.getTime()+')/"';else if(c.toJSON)e=c.toJSON();else try{e=JSON.stringify(c)}catch(d){console.warn(d);continue}h++&&(a+=",");a+='"'+b+'":'+e}return a},destructor:function(){this.__i__=!1},propertyChange:function(a){var b=r[this._id];b&&b.propagate(this._id,a)},propagateChange:function(a){this.propertyChange(a)},
link:function(a){if(a instanceof m.core.Model)this.__model&&this.__model.unlinkTo(this),this.__model=a,this.__model.linkTo(this),this.configure(this.__model);else throw"vs.core.Object.link; parameter is not a vs.core.Model";},unlink:function(){if(this.__model){if(this.__model){this.__model.unlinkTo(this);var a=this.__model.getProperties();for(l=a.length,config={};l--;)config[a[l]]=null;this.configure(config)}this.__model=v}},clone:function(a,b){function c(a,b,c){var e=b.__lookupGetter__(a),g=b.__lookupSetter__(a),
h=c.__lookupGetter__(a),j=c.__lookupSetter__(a);e&&!h&&c.__defineGetter__(a,e);g&&!j&&c.__defineSetter__(a,g);!g&&!e&&(e=b[a],c[a]=f.isArray(e)?e.slice():b[a])}function e(a,b,c){var e=b.getOwnPropertyDescriptor(a),g=c.getOwnPropertyDescriptor(a);e&&(e.get||e.set)?g||f.defineProperty(c,a,e):(e=b[a],c[a]=f.isArray(e)?e.slice():b[a])}function g(a,b,c){var e=b.__lookupGetter__(a),g=b.__lookupSetter__(a),h=c.__lookupSetter__(a);if(g||e)h?c[a]=b["_"+a]:c["_"+a]=b["_"+a]}function h(a,b,c){var e=b.getOwnPropertyDescriptor(a),
g=c.getOwnPropertyDescriptor(a);if(e&&g&&(e.get||e.set))g.set?c[a]=b["_"+a]:c["_"+a]=b["_"+a]}var j,d;b||(b={});if(b[this._id])return b[this._id];a||(a={});a.id||(a.id=t());if(f.isFunction(this.constructor))j=new this.constructor(a);else return console.warn("impossible to clone this object."),null;b[this._id]=j;var i=Object.defineProperty?e:c,k=Object.defineProperty?h:g;for(d in this)this.hasOwnProperty(d)&&(f.isFunction(this[d])&&!f.isFunction(j[d])?j[d]=this[d]:i(d,this,j));j.__i__=!1;j.init();
this._clone(j,a,b);for(d in this)"id"==d||"_id"==d||this.hasOwnProperty(d)&&k(d,this,j);this.__model&&(b&&b[this.__model._id]?j.link(b[this.__model._id]):j.link(this.__model));return j},_clone:function(){},getOwnPropertyDescriptor:function(a){return Object.getOwnPropertyDescriptor(this,a)},getPropertyDescriptor:function(a){function b(a,c){if(!a)return null;var h=Object.getPrototypeOf(a);if(!h)return null;var j=Object.getOwnPropertyDescriptor(h,c);return j?j:b(h,c)}var c=Object.getOwnPropertyDescriptor(this,
a);return c?c:b(this,a)},_super:function(){var a=this._super.caller._super_func_;a&&a.apply(this,arguments)}};f.defineClassProperty(p,"id",{get:function(){return this._id}});p._obs={};i.Object=p;var L=Object.prototype.constructor;m.core.Object.PROPERTY_IN=1;m.core.Object.PROPERTY_OUT=2;m.core.Object.PROPERTY_IN_OUT=3;var K=/(\w+[.\w+]*)#(\w+)/;i.createClass=function(a){var b=null,c={},e=m.core.Object,g={},b=function(){this.parent=b.__spec.parent;b.__spec&&b.__spec._constructor?b.__spec._constructor.apply(this,
arguments):b.__spec&&b.__spec.parent&&this.parent.apply(this,arguments);this.constructor=b};a&&a.parent&&(e=a.parent,delete a.parent);a&&a.properties&&(g=a.properties,delete a.properties);c.parent=e;a&&a.constructor&&a.constructor!==L&&(c._constructor=a.constructor,c._constructor._super_func_=e);b.__spec=c;a&&(b.prototype=a,a.constructor=b);e.prototype&&f.extendClass(b,e);if(a)for(key in a)if(a.hasOwnProperty(key)){var c=a[key],h=e.prototype[key];f.isFunction(c)&&f.isFunction(h)&&(c._super_func_=
h)}J(b,g);return b};z.prototype={__bindings__:null,__links__:null,__should_propagate_changes__:!0,_sync_service_:null,destructor:function(){i.Object.prototype.destructor.call(this);this._sync_service_&&this._sync_service_.removeModel(this);for(var a in this.__bindings__){var b=this.__bindings__[a];if(b)for(var c=void 0,e=b.length;e--;)c=b[e],f.free(c);delete this.__bindings__[a]}delete this.__bindings__},bindChange:function(a,b,c){b&&(a=a||"change",c=new E(a,b,c,!1),b=this.__bindings__[a],b||(b=[],
this.__bindings__[a]=b),b.push(c))},unbindChange:function(a,b,c){a||(a="change");var e=this.__bindings__[a];if(e)for(var g,h=0;h<e.length;)g=e[h],g.spec===a?g.obj===b?f.isString(c)||f.isFunction(c)?g.func===c||g.func_ptr===c?(e.remove(h),f.free(g)):h++:(e.remove(h),f.free(g)):h++:h++},stopPropagation:function(){this.__should_propagate_changes__=!1},hasToPropagateChange:function(){return this.__should_propagate_changes__},change:function(a,b){var c;this.__should_propagate_changes__=!0;c=new C(this,
a||"change:"+a);try{if(!b)for(var e=this.__links__.length;e--;)this.__links__[e].configure(this);e=function(a){if(a)for(var b=a.length,e;b--;)if(e=a[b],e.func_ptr)e.func_ptr.call(e.obj,c);else if(e.func)e.obj[e.func](c);else e.obj.notify(c)};a&&"change"!=a&&e(this.__bindings__[a]);e(this.__bindings__.change)}catch(g){console.error(g)}},linkTo:function(a){a instanceof m.core.Object&&-1===this.__links__.indexOf(a)&&this.__links__.push(a)},unlinkTo:function(a){a instanceof m.core.Object&&this.__links__.remove(a)},
propertyChange:function(a){var b=r[this._id];b&&b.propagate(this._id,a);if(this.__should_propagate_changes__){b=this.__links__.length;if(a)for(;b--;)this.__links__[b][a]=this[a];else for(;b--;)this.__links__[b].configure(this);this.change(null,!0)}}};f.extendClass(z,i.Object);i.Model=z;FORCE_EVENT_PROPAGATION_DELAY=!1;i.POINTER_START=m.POINTER_START;i.POINTER_MOVE=m.POINTER_MOVE;i.POINTER_END=m.POINTER_END;i.POINTER_CANCEL=m.POINTER_CANCEL;i.GESTURE_START=m.GESTURE_START;i.GESTURE_CHANGE=m.GESTURE_CHANGE;
i.GESTURE_END=m.GESTURE_END;var C=function(a,b,c){this.srcTarget=this.src=a;this.type=b;this.data=c};C.prototype={src:null,srcTarget:null,type:"",data:null,destructor:function(){delete this.src;delete this.srcTarget;delete this.type;delete this.data}};i.Event=C;i.FORCE_EVENT_PROPAGATION_DELAY=FORCE_EVENT_PROPAGATION_DELAY;i.EVENT_SUPPORT_GESTURE=!1;E.prototype.destructor=function(){delete this.spec;delete this.obj;delete this.delay;delete this.func_ptr;delete this.func};s.prototype={__bindings__:null,
__node_binds__:null,destructor:function(){var a,b,c;for(a in this.__bindings__)if(b=this.__bindings__[a]){for(;b.length;)c=b.pop(),f.free(c);delete this.__bindings__[a]}delete this.__bindings__;for(a in this.__node_binds__)if(c=this.__node_binds__[a],"undefined"===typeof c)console.warn("vs.core.Object.destructor, no bind <"+a+" exists.");else for(b=0;b<c.length;b++)data=c[b],data.n.removeEventListener(event,data.h);delete this.__node_binds__;p.prototype.destructor.call(this)},_clone:function(a,b){p.prototype._clone.call(this,
a,b);a.__bindings__={};a.__node_binds__={}},bind:function(a,b,c,e){if(a&&b)return b=new E(a,b,c,e),c=this.__bindings__[a],c||(c=[],this.__bindings__[a]=c),c.push(b),b},unbind:function(a,b,c){var e=this.__bindings__[a],g=0,h;if(e)for(;g<e.length;)h=e[g],h.spec===a?h.obj===b?f.isString(c)||f.isFunction(c)?h.func===c||h.func_ptr===c?(e.remove(g),f.free(h)):g++:(e.remove(g),f.free(h)):g++:g++},propagate:function(a,b,c,e){var g=this.__bindings__[a],h,j,d;if(g){h=new C(this,a,b);c&&(h.srcTarget=c);a=g.length;
try{for(d=function(){if(j.func_ptr)j.func_ptr.call(j.obj,h);else if(j.func)j.obj[j.func](h);else j.obj.notify(h)};a--;)j=g[a],e||j.delay?setTimeout(d,0):d.call(this)}catch(f){console.error(f)}}else this.__parent&&(c||(c=this),this.__parent.propagate(a,b,c))},notify:function(a){this.propagate(a.type,a.data)},nodeBind:function(a,b,c,e){if(a&&f.isString(b)){var g=this,h=null,j=null,d,i;if("undefined"===typeof c)c="notify";else if(f.isString(c)){if(!f.isFunction(this[c])){console.warn("vs.core.Object.nodeBind, unknown function named: "+
c);return}}else if(f.isFunction(c))h=c,c=h.name;else{console.error("vs.core.Object.nodeBind, invalid func parameter");return}j=!e||e===k.ANY_MASK?function(a){try{a.src=a.currentTarget,a.data=a,h||(h=g[c]),h.call(g,a)}catch(b){console.error(b)}}:function(a){try{if(e||!a.altKey&&!a.ctrlKey&&!a.shiftKey&&!a.metaKey)e===k.ALT&&!a.altKey||e===k.CTRL&&!a.ctrlKey||e===k.SHIFT&&!a.shiftKey||e===k.META&&!a.metaKey||(a.src=a.currentTarget,a.data=a,h||(h=g[c]),h.call(g,a))}catch(b){console.error(b)}};i=b+c;
this.__node_binds__?(d=this.__node_binds__[i],"undefined"===typeof d&&(d=[],this.__node_binds__[i]=d),d.push({n:a,h:j}),m.addPointerListener(a,b,j,!1)):console.error("nodeBind impossible")}},nodeUnbind:function(a,b,c){if(a&&f.isString(b)){var e,g;if("undefined"===typeof c)c="notify";else if(f.isString(c)){if(!f.isFunction(this[c])){console.warn("vs.core.Object.nodeUnbind, unknown function named: "+c);return}}else if(f.isFunction(c))c=c.name;else{console.error("vs.core.Object.nodeBind, invalid func parameter");
return}e=this.__node_binds__[b+c];if("undefined"===typeof e)console.warn("vs.core.Object.nodeUnbind, no bind <"+b+","+c+"> exists.");else{for(c=0;c<e.length;)g=e[c],g.n===a?(a.removeEventListener(b,g.h),e.remove(c)):c++;a._object_=v}}}};f.extendClass(s,p);i.EventSource=s;var k=new s("__KEYBOARD__");k._handler_set_down=!1;k._handler_set_up=!1;k.managePrevent=function(a,b){var c=this.__bindings__[a],e,g;if(c)for(e=0;e<c.length;e++)if(g=c[e],g.prevent){b.preventDefault();break}};k.KEY_UP=1E3;k.ESC=27;
k.ENTER=13;k.SPACE=32;k.BACKSPACE=8;k.SHIFT=16;k.CTRL=17;k.ALT=18;k.NUMLOCK=144;k.LEFT_ARROW=37;k.UP_ARROW=38;k.RIGHT_ARROW=39;k.DOWN_ARROW=40;k.L=76;k.S=83;k.Z=90;k.META=2E3;k.ANY_MASK=3E3;k.UNDO=256;k.REDO=257;k.SAVE=258;i.KEYBOARD=k;i.KEYBOARD.bind=function(a,b,c,e){var b=s.prototype.bind.call(this,a,b,c),g=this;e&&(b.prevent=!0);a>k.KEY_UP?this._handler_set_up||(H.documentElement.addEventListener("keyup",function(a){g.managePrevent(a.keyCode,a);g.propagate(a.keyCode+k.KEY_UP,a)},!1),this._handler_set_up=
!0):this._handler_set_down||(H.documentElement.addEventListener("keydown",function(a){(a.ctrlKey||a.metaKey)&&!a.shiftKey&&a.keyCode===k.Z?(g.propagate(k.UNDO),a.preventDefault()):(a.ctrlKey||a.metaKey)&&a.shiftKey&&a.keyCode===k.Z?(g.propagate(k.REDO),a.preventDefault()):(a.ctrlKey||a.metaKey)&&!a.shiftKey&&a.keyCode===k.S?(g.propagate(k.SAVE),a.preventDefault()):(a.ctrlKey||a.metaKey)&&!a.shiftKey&&a.keyCode?(g.managePrevent(k.META+a.keyCode,a),g.propagate(k.META+a.keyCode)):(g.managePrevent(a.keyCode,
a),g.propagate(a.keyCode,a))},!1),this._handler_set_down=!0)};var y=function(a){this.parent=i.EventSource;this.parent(t());this.constructor=y;this.owner=a;this._list_of_state={};this._list_input=[];this._list_output=[];this._current_state=this._initial_state="";this._inputs={};this._output_action={}};y.prototype={destructor:function(){delete this._list_of_state;this.owner=v;delete this._list_of_state;delete this._list_input;delete this._list_output;delete this._inputs;delete this._output_action;i.EventSource.prototype.destructor.call(this)},
_clone:function(a,b){s.prototype._clone.call(this,a,b);a.owner=a.__config__.owner;a._current_state="";a._inputs={};a._output_action={}},initWithData:function(a,b,c,e){if(a&&b&&c&&e){for(var g=0;g<a.length;g++)this.addState(a[g]);for(g=0;g<b.length;g++)this.addInput(b[g]);for(g=0;g<c.length;g++)this.addOutput(c[g]);for(g=0;g<e.length;g++)this.addTransition(e[g].from,e[g].to,e[g].on,e[g].output)}},initWithMatrix:function(a){for(var b=1;b<a[0].length;b++)this.addState(a[0][b]);for(b=1;b<a.length;b++)for(var c=
a[b][0],e=1;e<a[0].length;e++){var g=a[0][e],h=a[b][e];h&&(h=h.split("/"),h[0]&&this.addInput(h[0]),h[1]&&this.addOutput(h[1]),this.addTransition(c,g,h[0],h[1]))}},addInput:function(a){a&&!this.existInput(a)&&this._list_input.push(a)},getInputs:function(){return this._list_input.slice()},existInput:function(a){return!a?void 0:-1<this._list_input.findItem(a)},addOutput:function(a){a&&!this.existOutput(a)&&this._list_output.push(a)},getOutputs:function(){return this._list_output.slice()},existOutput:function(a){return!a?
void 0:-1<this._list_output.findItem(a)},addState:function(a){if(!a||this.existState(a))return!1;this._list_of_state[a]={transitionEvents:{}};return!0},removeState:function(a){if(!a||!this.existState(a))return!1;delete this._list_of_state[a];return!0},renameState:function(a,b){if(!a||!this.existState(a)||!b||this.existState(b))return!1;this._list_of_state[b]=this._list_of_state[a];delete this._list_of_state[a];this._initial_state===a&&(this._initial_state=b);for(var c in this._list_of_state){var e=
this._list_of_state[c];if(null!==e)for(var g in e.transitionEvents){var h=e.transitionEvents[g];h.to===a&&(h.to=b)}}return!0},getListState:function(){var a=[],b;for(b in this._list_of_state)a.push(b);return a},existState:function(a){return!a?!1:this._list_of_state[a]?!0:!1},addTransition:function(a,b,c,e){a&&this.existState(a)&&b&&this.existState(b)&&c&&this.existInput(c)&&(this._list_of_state[a].transitionEvents[c]={on:c,to:b,output:e})},removeTransitionFrom:function(a,b){if(a&&this.existState(a)&&
b&&this.existInput(b)){var c=this._list_of_state[a];c.transitionEvents[b]&&delete c.transitionEvents[b]}},removeTransitionTo:function(a,b){if(a&&this.existState(a)&&b&&this.existInput(b))for(var c in this._list_of_state){var e=this._list_of_state[c],g=e.transitionEvents[b];g&&g.to===a&&delete e.transitionEvents[b]}},getTransionsToState:function(a){if(this.existState(a)){var b=[],c;for(c in this._list_of_state){var e=this._list_of_state[c];if(null!==e)for(var g in e.transitionEvents){var h=e.transitionEvents[g];
h.to===a&&(h=f.clone(h),h.from=c,b.push(h))}}return b}},getTransionsFromState:function(a){if(this.existState(a)){var b=[],c=this._list_of_state[a];if(null===c)return null;for(var e in c.transitionEvents){var g=f.clone(c.transitionEvents[e]);g.from=a;b.push(g)}return b}},switchStates:function(a,b){if(!(a===b||!this.existState(a)||!this.existState(b))){for(var c=this.getTransionsToState(a),e=this.getTransionsFromState(a),g=this.getTransionsToState(b),h=this.getTransionsFromState(b),d=0;d<c.length;){var f=
c[d];f.from===b?c.remove(f):d++}for(d=0;d<e.length;)f=e[d],f.to===b?e.remove(f):d++;for(d=0;d<c.length;d++)f=c[d],this.removeTransitionFrom(f.from,f.on);for(d=0;d<e.length;d++)f=e[d],this.removeTransitionFrom(f.from,f.on);for(d=0;d<g.length;d++)f=g[d],this.removeTransitionFrom(f.from,f.on);for(d=0;d<h.length;d++)f=h[d],this.removeTransitionFrom(f.from,f.on);for(d=0;d<c.length;d++){var f=c[d],i=f.from===b?a:f.from;this.addTransition(i,b,f.on,f.output)}for(d=0;d<e.length;d++)f=e[d],c=f.from===b?a:f.to,
this.addTransition(b,c,f.on,f.output);for(d=0;d<g.length;d++)f=g[d],i=f.from===a?b:f.from,this.addTransition(i,a,f.on,f.output);for(d=0;d<h.length;d++)f=h[d],c=f.to===a?b:f.to,this.addTransition(a,c,f.on,f.output);this._initial_state===a?this._initial_state=b:this._initial_state===b&&(this._initial_state=a)}},setInput:function(a,b,c){if(a&&b&&c){if(b.bind)b.bind(c,this);else if(b.addEventListener)this.nodeBind(b,c);else return;var e=this._inputs[b];e||(e=[],this._inputs[b]=e);e.push([c,a,b])}},setOutput:function(a,
b){a&&b&&(this._output_action[a]=b)},activate:function(){if(!this._initial_state||!this._list_of_state[this._initial_state])return!1;this.goTo(this._initial_state);return!0},goTo:function(a,b,c){if(!this.existState(a))return!1;this._current_state=a;if(b&&this._output_action[b])if(a=this._output_action[b],a instanceof Function)a.call(this.owner,c);else if(f.isString(a))this.owner[this._output_action[b]](c);return!0},clear:function(){this._list_of_state={};delete this._list_input;delete this._list_output;
this._list_input=[];this._list_output=[];this._initial_state="";for(var a in this._inputs)for(var b=this._inputs[a],c=0;c<b.length;c++){var e=b[c][2],g=b[c][0];e.bind?e.unbind(g,this):e.addEventListener&&this.nodeUnbind(e,g)}this._current_state=""},notify:function(a){var b=this._inputs[a.src];if(b)for(var c=0;c<b.length;c++)a.type===b[c][0]&&this._list_of_state[this._current_state]&&this.fsmNotify(b[c][1],a.data)},fsmNotify:function(a,b,c){if(this._list_of_state[this._current_state]){var e=this._list_of_state[this._current_state].transitionEvents[a];
if(!e)return!1;this.goTo(e.to,e.output,{on:a,data:b},c);return!0}}};f.extendClass(y,s);f.defineClassProperty(y,"initialState",{set:function(a){a?this.existState(a)&&(this._initial_state=a):this._initial_state=v},get:function(){return this._initial_state}});i.Fsm=y;F.prototype={propagate_values:function(a){var b=this.dataflow_edges[a],c,e,g,d,j,i;if(b){e=p._obs[a];for(a=0;a<b.length;a++)if(j=p._obs[b[a][0]])if(i=b[a][2]){for(c=0;c<i.length;c++){g=i[c][0];d=i[c][1];var k=e.getPropertyDescriptor(g),
m=j.getPropertyDescriptor(d);if(!k||!k.get)if(g="_"+f.underscore(g),!e.hasOwnProperty(g))continue;if(!m||!m.set)if(d="_"+f.underscore(d),!j.hasOwnProperty(d))continue;j[d]=e[g]}j.__should__call__has__changed__=!0}}},propagate:function(a){if(!this.is_propagating&&!this.__shouldnt_propagate__){this.is_propagating=!0;var b=0;if(a){for(;b<this.dataflow_node.length&&this.dataflow_node[b]!==a;)b++;b<this.dataflow_node.length-1&&(this.propagate_values(a),b++)}for(;b<this.dataflow_node.length;b++)if(a=p._obs[this.dataflow_node[b]])a.__should__call__has__changed__&&
a.propertiesDidChange&&(a.propertiesDidChange(),a.__should__call__has__changed__=!1),this.propagate_values(a.id);this.is_propagating=!1}},build:function(){if(this._ref_node&&this._ref_edges){var a=[],b,c,e,g,d,f;for(b=0;b<this._ref_node.length;b++)c=this._ref_node[b],this._node_link[c]&&a.push(this._node_link[c]);this.dataflow_node=a;a={};for(c in this._ref_edges)if(this._node_link[c]){e=this._ref_edges[c];g=[];for(b=0;b<e.length;b++)d=e[b],f=[3],this._node_link[d[0]]&&(f[0]=this._node_link[d[0]],
f[1]=d[1],f[2]=d[2].slice(),g.push(f));a[this._node_link[c]]=g}this.dataflow_edges=a}},register_ref_node:function(a){a&&(this._ref_node=a)},register_ref_edges:function(a){a&&(this._ref_edges=a)},pausePropagation:function(){this.__shouldnt_propagate__++},restartPropagation:function(){this.__shouldnt_propagate__--;0>this.__shouldnt_propagate__&&(this.__shouldnt_propagate__=0)}};var r={};m._df_node_register=function(a,b,c){if(a&&b&&c&&(a=r[a]))a._node_link[b]=c,r[c]=a};m._df_create=function(a,b){var c=
new F;c.ref=b;return r[a]=c};m._df_register_ref_node=function(a,b){if(a&&b){var c=r[a];c&&c.register_ref_node(b)}};m._df_register_ref_edges=function(a,b){if(a&&b){var c=r[a];c&&c.register_ref_edges(b)}};m._df_build=function(a){a&&(a=r[a])&&a.build()};i.DataFlow=F;n.STARTED=1;n.STOPPED=0;n.PAUSED=2;n.prototype={delegate:null,_state:n.STOPPED,start:function(){},stop:function(){},pause:function(){}};f.extendClass(n,i.Object);f.defineClassProperty(n,"state",{get:function(){return this._state}});A.prototype=
{_tasksAndParams:null,_tasksWillEnded:null,setTasks:function(a){if(this._state!==n.STOPPED)return!1;var b,c,e,d;this._tasksAndParams=[];for(b=0;b<a.length;b++)if(c=a[b])e=d=null,f.isArray(c)?1===c.length?e=c[0]:2===c.length&&(e=c[0],d=c[1]):(e=c,d=null),e?!e.start||!e.stop||!e.pause?console.warn("Invalid task: "+e.toString()):this._tasksAndParams.push([e,d]):console.warn("Undefined task")},start:function(a){if(this._state===n.STARTED)return!1;this._tasksWillEnded=this._tasksAndParams.length;this._state=
n.STARTED;var b,c;for(c=0;c<this._tasksAndParams.length;c++)b=this._tasksAndParams[c],b[0].delegate=this,b[0].start(b[1]?b[1]:a);return!0},stop:function(){if(this._state===n.STOPPED)return!1;this._state=n.STOPPED;var a,b;for(b=0;b<this._tasksAndParams.length;b++)a=this._tasksAndParams[b],a[0].stop();return!0},pause:function(){if(this._state===n.PAUSED)return!1;this._state=n.PAUSED;var a,b;for(b=0;b<this._tasksAndParams.length;b++)a=this._tasksAndParams[b],a[0].pause();return!0},taskDidStop:function(){this._state=
n.STOPPED;this._tasksWillEnded--;0===this._tasksWillEnded&&this.delegate&&this.delegate.taskDidEnd&&this.delegate.taskDidEnd(this)},taskDidPause:function(){this._state=n.STOPPED;this._tasksWillEnded--;0===this._tasksWillEnded&&this.delegate&&this.delegate.taskDidEnd&&this.delegate.taskDidEnd(this)},taskDidEnd:function(){this._state=n.STOPPED;this._tasksWillEnded--;0===this._tasksWillEnded&&this.delegate&&this.delegate.taskDidEnd&&this.delegate.taskDidEnd(this)}};f.extendClass(A,i.Object);B.prototype=
{_tasksAndParams:null,_nextTaskToStart:0,_startParam:null,setTasks:function(a){if(this._state!==n.STOPPED)return!1;var b,c,e,d;this._tasksAndParams=[];for(b=0;b<a.length;b++)if(c=a[b])e=d=null,f.isArray(c)?1===c.length?e=c[0]:2===c.length&&(e=c[0],d=c[1]):(e=c,d=null),e?!e.start||!e.stop||!e.pause?console.warn("Invalid task: "+e.toString()):this._tasksAndParams.push([e,d]):console.warn("Undefined task")},start:function(a){if(this._state===n.STARTED)return!1;this._state=n.STARTED;this._startParam=
a;var b=this._tasksAndParams[this._nextTaskToStart];if(!b)return!1;this._nextTaskToStart++;b[0].delegate=this;b[0].start(b[1]?b[1]:a);return!0},stop:function(){if(this._state===n.STOPPED)return!1;this._state=n.STOPPED;var a=this._tasksAndParams[this._nextTaskToStart-1];if(!a)return!1;this._nextTaskToStart=0;a[0].stop();return!0},pause:function(){if(this._state===n.PAUSED)return!1;this._state=n.PAUSED;var a=this._tasksAndParams[this._nextTaskToStart-1];if(!a)return!1;a[0].pause();return!0},taskDidStop:function(){this._state=
n.STOPPED;0===this._nextTaskToStart&&(this._nextTaskToStart-=1);this.delegate&&this.delegate.taskDidStop&&this.delegate.taskDidStop(this)},taskDidPause:function(){this._state=n.PAUSED;this._nextTaskToStart-=1;this.delegate&&this.delegate.taskDidPause&&this.delegate.taskDidPause(this)},taskDidEnd:function(){this._state=n.STOPPED;this._nextTaskToStart<this._tasksAndParams.length?this.start(this._startParam):(this._nextTaskToStart=0,this.delegate&&this.delegate.taskDidEnd&&this.delegate.taskDidEnd(this))}};
f.extendClass(B,i.Object);w.prototype={_time:0,_left_time:0,_timer:null,_start_time:0,start:function(){var a=this,b=this._time;if(this._state===n.STARTED)return!1;this._state===n.PAUSED?b=this._left_time:this._left_time=b;this._state=n.STARTED;this._start_time=(new Date).getTime();a=this;this._timer=setTimeout(function(){a._state=n.STOPPED;a.delegate&&a.delegate.taskDidEnd&&a.delegate.taskDidEnd(a)},b);return!0},stop:function(){if(this._state===n.STOPPED)return!1;this._state=n.STOPPED;clearTimeout(this._timer);
this._timer=null;this._left_time=this._time;this.delegate&&this.delegate.taskDidStop&&this.delegate.taskDidStop(this);return!0},pause:function(){if(this._state===n.PAUSED)return!1;this._state=n.PAUSED;this._left_time=this._left_time-(new Date).getTime()+this._start_time;this.delegate&&this.delegate.taskDidPause&&this.delegate.taskDidPause(this);return!0}};f.extendClass(w,i.Object);f.defineClassProperty(w,"state",{set:function(a){f.isNumber(a)&&(this._time=a)}});f.extend(i,{Task:n,Task_PAR:A,Task_SEQ:B,
TaskWait:w});d.OS_UNKNOWN=0;d.OS_WINDOWS=1;d.OS_MACOS=2;d.OS_LINUX=4;d.OS_IOS=5;d.OS_WP7=6;d.OS_BLACK_BERRY=7;d.OS_SYMBIAN=8;d.OS_ANDROID=9;d.OS_MEEGO=10;d.SR_UNKNOWN=0;d.SR_QVGA=1;d.SR_WQVGA=2;d.SR_HVGA=4;d.SR_VGA=5;d.SR_WVGA=6;d.SR_FWVGA=7;d.SR_SVGA=8;d.SR_DVGA=9;d.SR_WDVGA=10;d.SR_XGA=11;d.SR_N_HD=12;d.SR_Q_HD=13;d.SR_WXGA=14;d.SR_QXGA=15;d.BROWSER_UNKNOWN=0;d.BROWSER_CHROME=1;d.BROWSER_SAFARI=2;d.BROWSER_OPERA=3;d.BROWSER_FIREFOX=4;d.BROWSER_MSIE=5;d.SS_UNKNOWN=0;d.SS_4_INCH=1;d.SS_7_INCH=2;d.SS_10_INCH=
3;d.prototype={os:d.OS_UNKNOWN,browser:d.BROWSER_UNKNOWN,screenResolution:d.SR_UNKNOWN,screenRatio:0,screenSize:d.SS_UNKNOWN,browserDetect:function(){function a(a){for(var c=a.length;c--;){var e=a[c].string,d=a[c].prop;this.versionSearchString=a[c].versionSearch||a[c].identity;if(e){if(e.match(a[c].subString))return a[c].identity}else if(d)return a[c].identity}}this.browser=a(d._data_browser)||d.BROWSER_UNKNOWN;this.os=a(d._data_OS)||d.OS_UNKNOWN},orientationDetect:function(){this.orientation=o.orientation?
o.orientation:o.outerWidth>o.outerHeight?90:0},screenDetect:function(){var a=o.devicePixelRatio,b,c;a||(a=1);this.os>=d.OS_IOS&&this.os<=d.OS_MEEGO?(b=o.screen.width,c=o.screen.height):(b=o.outerWidth,c=o.outerHeight);if(b>c){var e=b;b=c;c=e}this.screenResolution=d._getScreenResolutionCode(b,c);this.screenRatio=c/b;a=Math.sqrt(b*b+c*c)/(160*a);6>a?this.screenSize=d.SS_4_INCH:9>a?this.screenSize=d.SS_7_INCH:11>a&&(this.screenSize=d.SS_10_INCH)},getOrientation:function(){return this.orientation},setDeviceId:function(a){if(f.isString(a))if(this.deviceId=
a,-1!=a.indexOf("wp7"))this.os=d.OS_WP7,this.screenResolution=d.SR_WVGA,this.screenRatio=1.6;else if(-1!=a.indexOf("iphone"))this.os=d.OS_IOS,this.screenResolution=d.SR_HVGA,-1!=a.indexOf("_3_2")?this.screenRatio=1.5:-1!=a.indexOf("_16_9")&&(this.screenRatio=16/9);else if(-1!=a.indexOf("ipad"))this.os=d.OS_IOS,this.screenResolution=d.SR_XGA,this.screenRatio=4/3;else if(-1!=a.indexOf("nokia_s3"))this.os=d.OS_SYMBIAN,this.screenResolution=d.SR_N_HD,this.screenRatio=4/3;else if(-1!=a.indexOf("android")){this.os=
d.OS_ANDROID;-1!=a.indexOf("_3_2")?this.screenRatio=1.5:-1!=a.indexOf("_16_10")?this.screenRatio=1.6:-1!=a.indexOf("_16_9")&&(this.screenRatio=16/9);var a=o.screen.width,b=o.screen.height;a>b&&(a=o.screen.height,b=o.screen.width);this.screenResolution=d._getScreenResolutionCode(a,b)}else-1!=a.indexOf("blackberry")&&(this.os=d.OS_BLACK_BERRY,a.indexOf("_4_3")?this.screenRatio=4/3:a.indexOf("_3_2")?this.screenRatio=1.5:a.indexOf("_16_10")&&(this.screenRatio=1.6),a=o.screen.width,b=o.screen.height,this.screenResolution=
d._getScreenResolutionCode(a,b))},setOrientation:function(a,b){var c,e,d;d=o.innerWidth;var f=o.innerHeight,j;if(this.orientation!==a){d>f&&(j=f,f=d,d=j);for(e in i.Object._obs)if(d=i.Object._obs[e])d._orientationWillChange&&d._orientationWillChange(a),d.orientationWillChange&&d.orientationWillChange(a);for(c in this.targets)if(e=this.targets[c],e.device===this.deviceId&&(!(0!==a&&180!==a||-1===c.indexOf("_p"))||!(90!==a&&-90!==a||-1===c.indexOf("_l")))){this.setActiveStyleSheet(c);break}this.orientation=
a;e=function(){var b,c;for(b in i.Object._obs)(c=i.Object._obs[b])&&c.orientationDidChange&&c.orientationDidChange(a)};b?e.call(this):setTimeout(e,100);return c}},setActiveStyleSheet:function(a){f.setActiveStyleSheet(a);m._current_platform_id=a},registerTargetId:function(a,b){this.targets[a]=b}};d._getScreenResolutionCode=function(a,b){if(240===a&&320===b)return d.SR_QVGA;if(240===a&&400===b)return d.SR_WQVGA;if(320===a&&480===b)return d.SR_HVGA;if(480===a&&640===b)return d.SR_VGA;if(480===a&&800===
b)return d.SR_WVGA;if(320===a&&854===b)return d.SR_WFVGA;if(600===a&&800===b)return d.SR_SVGA;if(640===a&&960===b)return d.SR_DVGA;if(640===a&&1136===b)return d.SR_WDVGA;if(768===a&&1024===b)return d.SR_XGA;if(360===a&&640===b)return d.SR_N_HD;if(540===a&&960===b)return d.SR_Q_HD;if(720===a&&1280===b||768===a&&1280===b||800===a&&1280===b)return d.SR_WXGA;if(1536===a&&2048===b)return d.SR_QXGA};d._estimateScreenSize=function(a){var b=a.width/a.xdpi,a=a.height/a.ydpi,b=Math.sqrt(b*b+a*a);return 5>b?
3:8>b?7:10};d._data_browser="undefined"!=typeof navigator?[{string:navigator.userAgent,subString:"Chrome",identity:d.BROWSER_CHROME},{string:navigator.vendor,subString:"Apple",identity:d.BROWSER_SAFARI,versionSearch:"Version"},{prop:o.opera,identity:d.BROWSER_OPERA,versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:d.BROWSER_FIREFOX},{string:navigator.userAgent,subString:"MSIE",identity:d.BROWSER_MSIE,versionSearch:"MSIE"}]:[];d._data_OS="undefined"!=typeof navigator?
[{string:navigator.platform,subString:"Win",identity:d.OS_WINDOWS},{string:navigator.platform,subString:"Mac",identity:d.OS_MACOS},{string:navigator.platform,subString:"Linux",identity:d.OS_LINUX},{string:navigator.userAgent,subString:"iPad|iPhone|iPod",identity:d.OS_IOS},{string:navigator.userAgent,subString:"Android",identity:d.OS_ANDROID}]:[];"undefined"!=typeof o&&!o.deviceConfiguration&&(o.deviceConfiguration=new d);i.DeviceConfiguration=d;HTTPRequest=function(a){this.parent=i.EventSource;this.parent(a);
this.constructor=HTTPRequest};HTTPRequest.prototype={_url:"",_method:"GET",_login:"",_password:"",_content_type:"",send:function(a){var b=new XMLHttpRequest;this._response_xml=this._response_text=null;b.open(this._method,this._url,!0,this._login||null,this._password||null);b.setRequestHeader("Cache-Control","no-cache");b.setRequestHeader("Pragma","no-cache");this._content_type&&b.setRequestHeader("Content-Type",this._content_type);var c=this;b.onreadystatechange=function(){if(4===b.readyState)if(200===
b.status)if(b.responseText)c._response_text=b.responseText,c._response_xml=b.responseXML,c.propagateChange(),c.propagate("textload",c._response_text),c._response_xml&&c.propagate("xmlload",c._response_xml);else return c.propagate("loaderror","file not found."),!1;else{var a;try{a=JSON.parse(b.responseText)}catch(d){a=b.responseText}c.propagate("loaderror",{status:b.status,response:a});return!1}};b.send(a)}};f.extendClass(HTTPRequest,i.EventSource);f.defineClassProperties(HTTPRequest,{url:{set:function(a){f.isString(a)&&
(this._url=a)}},method:{set:function(a){"GET"!=a&&"POST"!=a||(this._method=a)}},login:{set:function(a){f.isString(a)&&(this._login=a)}},password:{set:function(a){f.isString(a)&&(this._password=a)}},contentType:{set:function(a){f.isString(a)&&(this._content_type=a)}},responseText:{get:function(){return this._response_text}},responseXML:{get:function(){return this._response_xml}}});i.HTTPRequest=HTTPRequest;x.prototype={_data:null,_model_class:null,initComponent:function(){this._data=[]},item:function(a){return this._data[a]},
_instanciateModel:function(a){if(a instanceof m.core.Model)return a;if(a instanceof Object&&this._model_class)try{var b=new this._model_class(a);b.init();return b}catch(c){console.error(c.toString())}return a},add:function(){for(var a=[],b=0;b<arguments.length;b++)a.push(this._instanciateModel(arguments[b]));this._data.push.apply(this._data,a);this.hasToPropagateChange()&&this.change("add");return this.length},addAtIndex:function(){if(!(2>arguments.length)){for(var a=[],b=1;b<arguments.length;b++)a.push(this._instanciateModel(arguments[b]));
this._data.splice.apply(this._data,a);this.hasToPropagateChange()&&this.change("add",a[0],a.length-2)}},remove:function(a,b){this._data.remove(a,b);this.hasToPropagateChange()&&this.change("remove",a,b)},removeAll:function(){this._data=[];this.hasToPropagateChange()&&this.change("removeall")},indexOf:function(){throw"method not yet implemented";},toJSON:function(){for(var a=this._toJSON("{"),b=0,c,a=a+', "data": [';b<this._data.length;b++)if(c=this._data[b])a=c.toJSON?a+c.toJSON():a+JSON.stringify(c),
b<this._data.length-1&&(a+=",");return a+"]}"},parseJSON:function(a){try{var b=a&&f.parseJSON(a)||{},c,e,d,h,j=this,a=function(a){j._data=[];for(c=0;c<a.length;c++)if(h=a[c],j._model_class){d=new j._model_class;d.init();for(e in h)d["_"+e]=h[e];j.add(d)}else j.add(h)};if(f.isArray(b))a(b);else for(e in b)this._data=[],"data"==e?a(b.data):this["_"+e]=b[e]}catch(i){console.error("vs.core.Array.parseJSON failed. "+i.toString())}}};f.extendClass(x,i.Model);f.defineClassProperties(x,{data:{set:function(a){if(!this.__i__)throw"Component not initialized";
if(f.isArray(a))this._data=a.slice();else if(a instanceof x)this._data=a._data.slice();else return;this.hasToPropagateChange()&&this.change("add")},get:function(){if(!this.__i__)throw"Component not initialized";return this._data.slice()}},length:{get:function(){if(!this.__i__)throw"Component not initialized";return this._data.length}},modelClass:{set:function(a){a instanceof Function&&(this._model_class=a)}}});i.Array=x;q.prototype={__models__:null,registerModel:function(a,b){a&&b&&(this.__models__[a]&&
error.log("Model with the name already registered."),this.__models__[a]=b,b._sync_service_=this)},removeModel:function(a){a&&this.__models__[a]&&delete this.__models__[a]},save:function(){},load:function(){}};f.extendClass(q,i.EventSource);i.DataStorage=q;G.prototype={save:function(a){function b(a){var b,d=c.__models__[a];if(d){try{b=d.toJSON?d.toJSON():JSON.stringify(d)}catch(f){error.log(f),c.propagate("error",f)}localStorage.setItem(a,b)}}var c=this;if(a)b(a);else for(a in this.__models__)b(a);
c.propagate("save")},load:function(a){function b(a){try{var b=c.__models__[a];if(b){var d=localStorage.getItem(a);b.parseJSON(d)}}catch(f){console.error("LocalStorate.load failed. "+f.toString())}}var c=this;if(a)b(a);else for(a in this.__models__)b(a);c.propagate("load")}};f.extendClass(G,q);i.LocalStorage=G;u.prototype={_xhrs:null,_url:"",initComponent:function(){q.prototype.initComponent.call(this)},destructor:function(){q.prototype.destructor.call(this)},save:function(a){function b(a){var b,d=
c.__models__[a];if(d){try{b=d.toJSON?d.toJSON():JSON.stringify(d)}catch(f){error.log(f),c.propagate("error",f)}u.setItem(a,b)}}var c=this;if(a)b(a);else for(a in this.__models__)b(a);c.propagate("save")},load:function(a){function b(a){try{var b=c.__models__[a];if(b){var d=c._url+a+".json",f=b.getProperties(),i=0;if(f&&f.length)for(var d=d+"?",k=0;k<f.length;k++){var m=f[k],n=b["_"+m];"undefined"!=typeof n&&(i++&&(d+=";"),d+=m+"="+n)}var o=(new HTTPRequest).init();c._xhrs[o.id]=a;o.bind("textload",
c,c._processResult);o.url=d;o.method="GET";o.contentType="application/json";o.send()}}catch(p){console.error("LocalStorate.load failed. "+p.toString())}}var c=this;if(a)b(a);else for(a in this.__models__)b(a)},_sync:function(){},_processResult:function(a){var b=a.data,a=a.src,c=this._xhrs[a.id];a.unbind("textload",this,this._processResult);m.util.free(a);delete this._xhrs[a.id];if(!b)return console.error("Failed to parse rss document that is null."),!1;if(a=this.__models__[c])a.parseJSON(b),this.propagate("load",
a)}};m.util.extendClass(u,q);m.util.defineClassProperties(u,{url:{set:function(a){m.util.isString(a)&&(this._url=a)},get:function(){return this._url}}});m.core.RestStorage=u})(window);
